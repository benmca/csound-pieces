(in-package :stella)
(defparameter *totaldur* 0)
;
(defobject quick (csound-note)
  ((instr :initform "i") inst mytime dur amp pitch pan)
  (:parameters instr inst mytime dur amp pitch pan))

(defobject revnote (csound-note)
  ((name :initform "i99") mystart dur revtime)
  (:parameters name mystart dur revtime))

;(defun test1 (st len tem pn)
;  (algorithm nil quick (start st length len)
;	(setf pan pn)
;    (setf inst (item (items 1 2 in random)))
;    (setf rhythm (item (items (rhythms q q e e q tempo(tempo tem)) (rhythms q q q q tempo(tempo tem))(rhythms e e e e q e e tempo(tempo tem))
;		(rhythms h q e e tempo(tempo tem)) in random)))
;    (setf dur (* (between 1 8) rhythm))
;    (setf pitch (between 1.3 1.6))
;    (setf amp (between 30000 32768))
;    (setf *totaldur* (max (+ time dur) *totaldur*))
;))

(defun josh4 (st len tem pn)
  (algorithm nil quick (start st length len)
		(setf pan pn)
        (setf inst 1)
		(setf rhythm 1)
		(setf dur 18.58)
		(setf pitch (between .99 1.01))
		(setf amp 1)
        (setf mytime (+ time (between .09 .1)))
	(setf *totaldur* (max (+ time dur) *totaldur*))
))

(defun josh3 (st len tem pn)
  (algorithm nil quick (start st length len)
		(setf pan pn)
        (setf inst 2)
		(setf rhythm 1)
		(setf dur 18.58)
		(setf pitch (between .99 1.01))
		(setf amp 1)
        (setf mytime (+ time (between .09 .1)))
	(setf *totaldur* (max (+ time dur) *totaldur*))
))



(defun spawner (st len)
    (mute nil (start st length len)
            (setf rhythm 0)
        (sprout
            (josh4 time 1 60 45)
        )
        (sprout
            (josh3 time 1 60 45)
        )
    )
)        

(defun mrn (&key (revtime 3.))
  (algorithm nil revnote (start 10000 length 1 revtime revtime rhythm 0)
	     (setf mystart 0)
	     (setf dur (+ revtime *totaldur* 1))
	     ))

(defun ms (&key (start-time 1.)(my-scorefile "..\\CsWork\\2003\\Crowd\\Crowd1.sco"))
  (let* ((myheader (header "f 1 0 16384 9 .5 1 0"
			   )))
    (fheader my-scorefile myheader)
    (merge all ()
        (spawner 1 400)
;		(mrn)
            )
    (open-cmd my-scorefile)
	(mix-cmd "all")))
